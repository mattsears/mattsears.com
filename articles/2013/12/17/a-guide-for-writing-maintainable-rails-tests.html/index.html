<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <title>Matt Sears | A Guide for Writing Maintainable Rails Tests</title>
  <link rel="icon" href="/assets/images/me.png" type="image/x-icon" />
  <link href="https://unpkg.com/tailwindcss@2.0.2/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/assets/css/main.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>A Guide for Writing Maintainable Rails Tests | Matt Sears</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="A Guide for Writing Maintainable Rails Tests" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Do you ever feel like you spend most of your day repairing tests in your Rails app? If you have been building Rails apps as long for as we have, then you know the importance of a robust test suite." />
<meta property="og:description" content="Do you ever feel like you spend most of your day repairing tests in your Rails app? If you have been building Rails apps as long for as we have, then you know the importance of a robust test suite." />
<link rel="canonical" href="https://mattsears.com/articles/2013/12/17/a-guide-for-writing-maintainable-rails-tests.html/" />
<meta property="og:url" content="https://mattsears.com/articles/2013/12/17/a-guide-for-writing-maintainable-rails-tests.html/" />
<meta property="og:site_name" content="Matt Sears" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2013-12-17T21:49:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="A Guide for Writing Maintainable Rails Tests" />
<script type="application/ld+json">
{"description":"Do you ever feel like you spend most of your day repairing tests in your Rails app? If you have been building Rails apps as long for as we have, then you know the importance of a robust test suite.","@type":"BlogPosting","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://mattsears.com/assets/images/me.png"}},"url":"https://mattsears.com/articles/2013/12/17/a-guide-for-writing-maintainable-rails-tests.html/","headline":"A Guide for Writing Maintainable Rails Tests","dateModified":"2013-12-17T21:49:00+00:00","datePublished":"2013-12-17T21:49:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mattsears.com/articles/2013/12/17/a-guide-for-writing-maintainable-rails-tests.html/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body class="text-gray-700 antialiased bg-white js-focus-visible">
    <div class=" max-w-screen-xl mx-auto overflow-hidden ">
      <nav class="relative flex space-x-10 justify-center sm:justify-end w-full px-10" aria-label="Tabs">
  
    <a href="/" class=" border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300  whitespace-nowrap py-4 px-1 border-b-2 font-medium text-md" aria-current="page">
      Home
    </a>
  
    <a href="/articles/" class=" border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300  whitespace-nowrap py-4 px-1 border-b-2 font-medium text-md" aria-current="page">
      Journal
    </a>
  
</nav>

      <div class="relative max-w-3xl py-16 bg-white overflow-hidden mx-auto">
        <div class="relative px-4 sm:px-6 lg:px-8">
          <div class="text-lg max-w-prose mx-auto">
            <h1 class="block text-center">
              <span class="text-base text-indigo-600  tracking-wide uppercase">Posted in </span>
              <span class="text-base text-indigo-600 font-bold tracking-wide uppercase">rails</span>
              <span class="mt-4 block text-3xl text-center leading-10 font-bold text-gray-900 sm:text-4xl">
                A Guide for Writing Maintainable Rails Tests
              </span>
            </h1>
            <h2 class="block text-center py-5">
              <span class="text-base text-center text-indigo-600 font-semibold tracking-wide">Matt Sears</span>
              <span class="text-base text-gray-800">|</span>
              <span class="text-base">Dec 17, 2013 </span>
            </h2>
            <div class="post mt-8 text-lg leading-8">
              <p>Do you ever feel like you spend most of your day repairing tests in your Rails
app? If you have been building Rails apps as long for as we have, then you know
the importance of a robust test suite.<!--more--> Working with a brittle and slow tests can
really make the most basic tasks difficult. This is especially true for large
Rails apps that have been around for a few years. The good news is that we can
fix this with a few helpful tips I’ve picked up over the years that can keep
your test suite running smoothly for the long-run.</p>

<p>First, let’s define what maintainable means. It can take on a lot meanings, but
let’s break it down into three categories:</p>

<ol>
  <li>
    <p><em>Tests should be reliable.</em> When we run our tests over and over; whether it’s
a single test or the entire test suite, we want them to consistently pass or
even consistently fail. There’s nothing more tedious than tracking down
inconsistencies. I’ve spent countless hours and sometimes days fixing tests
that run fine in isolation, but fail when running the complete suite.</p>
  </li>
  <li>
    <p><em>Tests should be easy to write.</em> I confess, when I work with a Rails app that
has slow or brittle tests, I skip writing new tests all together because I know
it’s too difficult or too time consuming setting up new tests. So it’s
critical that our test suite be straightforward enough to dive right in.</p>
  </li>
  <li>
    <p><em>Tests should be easy to understand.</em> When tests fail, we should be able to
look at the test code and quickly understand why it’s failing and how to
fix it. The last thing we want to do is waste time staring at code wondering
“Why is this failing!”.</p>
  </li>
</ol>

<h2 id="the-test-environment">The Test Environment</h2>

<p>Now that we have an understanding of what maintainable tests mean, let’s get
started with a solid foundation - the test helpers. Here is what our
<code class="language-plaintext highlighter-rouge">test_helper.rb</code> might look like:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"minitest/autorun"</span>
<span class="nb">require</span> <span class="s2">"mocha/setup"</span>
<span class="nb">require</span> <span class="s1">'simplecov'</span>
<span class="nb">require</span> <span class="s1">'capybara/dsl'</span>
<span class="nb">require</span> <span class="s1">'capybara/rails'</span>

<span class="no">SimpleCov</span><span class="p">.</span><span class="nf">start</span>

<span class="k">module</span> <span class="nn">TestHelper</span>
  <span class="kp">include</span> <span class="no">Capybara</span><span class="o">::</span><span class="no">DSL</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="no">DatabaseCleaner</span><span class="p">.</span><span class="nf">strategy</span> <span class="o">=</span> <span class="ss">:truncation</span>
    <span class="no">DatabaseCleaner</span><span class="p">.</span><span class="nf">clean_with</span><span class="p">(</span><span class="ss">:truncation</span><span class="p">)</span>
    <span class="no">DatabaseCleaner</span><span class="p">.</span><span class="nf">start</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">teardown</span>
    <span class="no">DatabaseCleaner</span><span class="p">.</span><span class="nf">clean</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Nice and simple! Let’s take a closer at the gems we’re using:</p>

<p><strong><a href="https://github.com/seattlerb/minitest">Minitest</a></strong> - I like to use MiniTest for
writing tests because of its simplicity and it provides a complete set of
testing facilities without the noise. Best of all it’s shipped with Ruby 1.9.</p>

<p><strong><a href="http://gofreerange.com/mocha/docs/">Mocha</a></strong> - When we absolutely <em>need</em> to
mock or stub, I reach for Mocha since it’s a good lightweight option. I found
Mocha to be the least fussy when it comes to stubbing.</p>

<p><strong><a href="https://github.com/colszowka/simplecov">SimpleCov</a></strong> is absolutely essential
  for measuring our code coverage. Our road to lean and mean tests start by
  knowing what has already been tested and what has yet to be tested.</p>

<p><strong><a href="https://github.com/bmabey/database_cleaner">DatabaseCleaner</a></strong> To avoid
banging our head against bizarre inconsistencies with the test database, we are
going to call on the help from DatbaseCleaner, which ensures that we have a clean database
state between tests.</p>

<p><strong><a href="http://jnicklas.github.io/capybara">Capybara</a></strong> Capybara is an intuitive web browser
simulation framework that allows us to test how a real user interacts with our web application. It
also comes with a built-in DSL for describing user interactions. We’ll use
Capybara extensively for our acceptance tests.</p>

<h2 id="achieving-testing-zen">Achieving Testing Zen</h2>

<p>Now that we have a nice setup for our suite, we’re ready to start adding
tests. How we approach testing is important if we want to keep our test suite
healthy. We want to write the minimal amount of code required to satisfy our
test cases. The best way to do this is using the Top-Down approach. This brings
us to our first tip.</p>

<p><strong>Tip #1: Start at the top.</strong> Start with the acceptance tests and drive our
  implementation at the user interface level. This can be a great way to
  prototype our implementation, and starting at the top, we can cover a lot of
  code with little tests. Once we are satisfied with our acceptance tests, we
  can fill-in holes with unit tests for complete public interface coverage.</p>

<p><strong>Tip #2: Use helper methods to keep your test DRY.</strong> To keep our tests nice and
   neat, extract common setup scenarios into helper methods. For example, if we
   know we have to log into the application to test our app, we can setup a
   handy login method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">log_in_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="no">User</span><span class="p">.</span><span class="nf">stubs</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">).</span><span class="nf">returns</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">visit</span> <span class="s2">"/login"</span>

  <span class="n">within</span><span class="p">(</span><span class="s2">"form"</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">fill_in</span> <span class="s2">"login"</span><span class="p">,</span> <span class="ss">with: </span><span class="n">user</span><span class="p">.</span><span class="nf">login</span>
    <span class="n">fill_in</span> <span class="s2">"password"</span><span class="p">,</span> <span class="ss">with: </span><span class="s2">"anything"</span>
  <span class="k">end</span>
  <span class="n">click_button</span> <span class="s2">"Log in"</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong>Tip #3: Avoid Copy and Paste.</strong> Sometimes it’s so easy to copy and paste code
   from one test to another - especially our setup code. Before you copy and paste,
   ask yourself “Should I move this code to a helper method instead?”.</p>

<p><strong>Tip #4: Don’t test what has already been tested.</strong> It may sound simple, but
chances are you’ve written tests for code that has already been tested without
knowing it. I come across something like this quite often:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_many</span><span class="p">(</span><span class="ss">:orders</span><span class="p">)}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>What exactly are we testing here? Are we just wanting to be extra sure that
we’ve spelled the <code class="language-plaintext highlighter-rouge">has_many :order</code> association correctly in the User
model? ActiveRecord associations are well-tested by the Rails test suite, so
there is not need to have this in our test suite.</p>

<p><strong>Tip #6: Avoid Excessive use of mocks, stubs, and expectations.</strong> Too many
   mocks and stubs can lead to unexpected results and expectations often serve
   no benefit at all and almost always lock you to the internal implementation
   of the thing you’re testing, thus making tests brittle. I have seen many
   projects use excessive mocks and often times it’s not testing
   anything. Prefer to use real data from the database. The downside of this of
   course, is that our tests may be slower.</p>

<p><strong>Tip #7: Makes tests fast enough.</strong> We’re not focusing too much on speed. Don’t get
me wrong, if your tests are slow, you won’t be encouraged to write them. So it’s
important to keep speed in mind. But in the end, the most important thing we
want is a reliable, understandable code, even if they’re not as fast as we’d like
them to be.</p>

<p><strong>Tip #8: Keep context and describe blocks flat.</strong> Avoid deeply nested describe
   contexts. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">describe</span> <span class="s2">"checking out"</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">"add items in shopping cart"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">add_item_to_shopping_cart</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
      <span class="n">click_link</span> <span class="s1">'Checkout'</span>
    <span class="k">end</span>
    <span class="o">...</span>

    <span class="n">describe</span> <span class="s2">"pay with credit card"</span> <span class="k">do</span>
      <span class="o">...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>When go too deep in our describe blocks, it’s easy to lose sight of the steps
taken in the previous describe blocks. To compound the problem, we can’t be sure
of the database state either. Consider breaking describe blocks into separate
tests or even separate files when deep nesting occurs. For our example above,
we’ll create a brand new test file for paying with credit card:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">describe</span> <span class="s2">"paying with credit card"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="n">setup_shopping_cart_and_checkout</span>
    <span class="n">fill_in_credit_card_fields</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'checks for valid promotion codes'</span> <span class="k">do</span>
    <span class="n">fill_in</span> <span class="s2">"promo_code"</span><span class="p">,</span> <span class="ss">with: </span><span class="s1">'does not exists'</span>
    <span class="n">click_link</span> <span class="s1">'Place Order'</span>
    <span class="n">assert</span> <span class="n">page</span><span class="p">.</span><span class="nf">has_content?</span><span class="p">(</span><span class="s2">"Sorry, invalid promotion code"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong>Tip #9: Only test public side effects.</strong> If a method changes the internal state, write
  your assertions based on the side effects available to the public. Keep test
  cases to external API - allows us to change internal implementation, while
  ensuring the consumers of your class still work.</p>

<p>And that is it! By following these tips, you’re on your way to achieving a happy
and health test suite. If you found this article helpful, you should also
checkout:</p>

<ol>
  <li><a href="http://robots.thoughtbot.com/practical-guide-to-user-testing/">Practical Guide to User Testing</a></li>
  <li><a href="http://blog.codeclimate.com/blog/2013/10/09/rails-testing-pyramid/">Rails Testing Pyramid</a></li>
  <li><a href="http://mattsears.com/articles/2011/12/10/minitest-quick-reference">Minitest Quick Reference</a></li>
</ol>

<p>Got any tips to share? Please leave them in the comments.</p>

            </div>
          </div>
        </div>
      </div>
      <div class="bg-white">
        <div class="mx-auto border-t border-gray-400 py-12 px-4 max-w-2xl sm:px-6 lg:px-8 lg:py-10">
          <div class="space-y-12">
            <ul class="space-y-12 sm:divide-y sm:divide-gray-200 sm:space-y-0 sm:-mt-8 lg:gap-x-8 lg:space-y-0">
              <li class="sm:p-8 rounded-lg">
                <div class="space-y-4 sm:grid sm:grid-cols-3 sm:items-start sm:gap-6 sm:space-y-0">
                  <!-- Image -->
                  <div class="aspect-w-3 aspect-h-2 sm:aspect-w-3 sm:aspect-h-4">
                    <img class="object-cover shadow-lg rounded-lg" src="/assets/images/me.png" alt="">
                  </div>
                  <div class="sm:col-span-2">
                    <div class="space-y-4">
                      <div class="text-lg leading-6 font-medium space-y-1">
                        <h3>Matt Sears</h3>
                        <p class="text-indigo-600">Engineer / Business / Design</p>
                      </div>
                      <div class="text-lg">
                        <p class="text-gray-500">
                          Thank you for checking out my website.
                        </p>
                      </div>
                      <div class="flex space-x-3">
                        <a href="https://instagram.com/mattsears" target="_blank" class="text-gray-400 hover:text-gray-300">
  <span class="sr-only">Instagram</span>
  <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
    <path fill-rule="evenodd" d="M12.315 2c2.43 0 2.784.013 3.808.06 1.064.049 1.791.218 2.427.465a4.902 4.902 0 011.772 1.153 4.902 4.902 0 011.153 1.772c.247.636.416 1.363.465 2.427.048 1.067.06 1.407.06 4.123v.08c0 2.643-.012 2.987-.06 4.043-.049 1.064-.218 1.791-.465 2.427a4.902 4.902 0 01-1.153 1.772 4.902 4.902 0 01-1.772 1.153c-.636.247-1.363.416-2.427.465-1.067.048-1.407.06-4.123.06h-.08c-2.643 0-2.987-.012-4.043-.06-1.064-.049-1.791-.218-2.427-.465a4.902 4.902 0 01-1.772-1.153 4.902 4.902 0 01-1.153-1.772c-.247-.636-.416-1.363-.465-2.427-.047-1.024-.06-1.379-.06-3.808v-.63c0-2.43.013-2.784.06-3.808.049-1.064.218-1.791.465-2.427a4.902 4.902 0 011.153-1.772A4.902 4.902 0 015.45 2.525c.636-.247 1.363-.416 2.427-.465C8.901 2.013 9.256 2 11.685 2h.63zm-.081 1.802h-.468c-2.456 0-2.784.011-3.807.058-.975.045-1.504.207-1.857.344-.467.182-.8.398-1.15.748-.35.35-.566.683-.748 1.15-.137.353-.3.882-.344 1.857-.047 1.023-.058 1.351-.058 3.807v.468c0 2.456.011 2.784.058 3.807.045.975.207 1.504.344 1.857.182.466.399.8.748 1.15.35.35.683.566 1.15.748.353.137.882.3 1.857.344 1.054.048 1.37.058 4.041.058h.08c2.597 0 2.917-.01 3.96-.058.976-.045 1.505-.207 1.858-.344.466-.182.8-.398 1.15-.748.35-.35.566-.683.748-1.15.137-.353.3-.882.344-1.857.048-1.055.058-1.37.058-4.041v-.08c0-2.597-.01-2.917-.058-3.96-.045-.976-.207-1.505-.344-1.858a3.097 3.097 0 00-.748-1.15 3.098 3.098 0 00-1.15-.748c-.353-.137-.882-.3-1.857-.344-1.023-.047-1.351-.058-3.807-.058zM12 6.865a5.135 5.135 0 110 10.27 5.135 5.135 0 010-10.27zm0 1.802a3.333 3.333 0 100 6.666 3.333 3.333 0 000-6.666zm5.338-3.205a1.2 1.2 0 110 2.4 1.2 1.2 0 010-2.4z" clip-rule="evenodd" />
  </svg>
</a>
<a href="https://github.com/mattsears" target="_blank" class="text-gray-400 hover:text-gray-300">
  <span class="sr-only">GitHub</span>
  <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
    <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd" />
  </svg>
</a>
<a href="https://linkedin.com/in/matthewsears" target="_blank" class="text-gray-400 hover:text-gray-300">
  <span class="sr-only">LinkedIn</span>
  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
    <path fill-rule="evenodd" d="M16.338 16.338H13.67V12.16c0-.995-.017-2.277-1.387-2.277-1.39 0-1.601 1.086-1.601 2.207v4.248H8.014v-8.59h2.559v1.174h.037c.356-.675 1.227-1.387 2.526-1.387 2.703 0 3.203 1.778 3.203 4.092v4.711zM5.005 6.575a1.548 1.548 0 11-.003-3.096 1.548 1.548 0 01.003 3.096zm-1.337 9.763H6.34v-8.59H3.667v8.59zM17.668 1H2.328C1.595 1 1 1.581 1 2.298v15.403C1 18.418 1.595 19 2.328 19h15.34c.734 0 1.332-.582 1.332-1.299V2.298C19 1.581 18.402 1 17.668 1z" clip-rule="evenodd" />
  </svg>
</a>

                      </div>
                    </div>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
