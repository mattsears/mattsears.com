<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if IE 8]> <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]> ><! <![endif]-->
<html class='no-js' lang='en'>
  <!-- <![endif] -->
  <head>
    <meta charset='utf-8' />
    <meta content='width=device-width, initial-scale=1.0' name='viewport' />
    <title>Matt Sears | A Guide for Writing Maintainable Rails Tests</title>
    <meta content='Matt Sears, Matt, Sears' name='keywords' />
    <meta author='Matt Sears' />
    <link href='http://feeds.feedburner.com/mattsears' rel='alternate' title='Feed for mattsears' type='application/atom+xml' />
    <link href='/images/favicon.png' rel='shortcut icon' />
    <link href='/fonts/ss-social.css' rel='stylesheet' />
    <link href="/stylesheets/app.css?1449018083" media="screen" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <nav>
      <div class='row'></div>
    </nav>
    <div class='row'>
      <div class='twelve columns centered'>
        <div class='row'>
  <div class='ten column centered'>
    <article>
      <header class='text-center'>
        <a href='/'>
          <img alt='Matt Sears' class='me' height='100' src='/images/matt-sears.png' title='Matt Sears' width='100' />
        </a>
        <h2>
          <a href='/articles/2013/12/17/a-guide-for-writing-maintainable-rails-tests'>
            A Guide for Writing Maintainable Rails Tests
          </a>
        </h2>
        <h5>
          Written by
          <a href='#'>Matt</a>
          on
          Dec 17
          /
          <span>
            <a class='dsq-comment-count comment-link commentslink' href='http://www.mattsears.com/articles/2013/12/17/a-guide-for-writing-maintainable-rails-tests#disqus_thread'></a>
          </span>
        </h5>
      </header>
      <div class='row'>
        <div class='ten column centered'>
          <p><em>This article was originally published at
<a href="http://littlelines.com/blog/2013/12/17/a-guide-for-writing-maintainable-rails-tests/">Littlelines</a>.</em></p>

<p>Do you ever feel like you spend most of your day repairing tests in your Rails
app? If you have been building Rails apps as long for as we have, then you know
the importance of a robust test suite. Working with a brittle and slow tests can
really make the most basic tasks difficult. This is especially true for large
Rails apps that have been around for a few years. The good news is that we can
fix this with a few helpful tips I&#39;ve picked up over the years that can keep
your test suite running smoothly for the long-run.</p>

<p>First, let&#39;s define what maintainable means. It can take on a lot meanings, but
let&#39;s break it down into three categories:</p>

<ol>
<li><p><em>Tests should be reliable.</em> When we run our tests over and over; whether it&#39;s
a single test or the entire test suite, we want them to consistently pass or
even consistently fail. There&#39;s nothing more tedious than tracking down
inconsistencies. I&#39;ve spent countless hours and sometimes days fixing tests
that run fine in isolation, but fail when running the complete suite.</p></li>
<li><p><em>Tests should be easy to write.</em> I confess, when I work with a Rails app that
has slow or brittle tests, I skip writing new tests all together because I know
it&#39;s too difficult or too time consuming setting up new tests. So it&#39;s
critical that our test suite be straightforward enough to dive right in.</p></li>
<li><p><em>Tests should be easy to understand.</em> When tests fail, we should be able to
look at the test code and quickly understand why it&#39;s failing and how to
fix it. The last thing we want to do is waste time staring at code wondering
&quot;Why is this failing!&quot;.</p></li>
</ol>

<h2>The Test Environment</h2>

<p>Now that we have an understanding of what maintainable tests mean, let&#39;s get
started with a solid foundation - the test helpers. Here is what our
<code>test_helper.rb</code> might look like:</p>
<div class="highlight"><pre><span class="nb">require</span> <span class="s2">&quot;minitest/autorun&quot;</span>
<span class="nb">require</span> <span class="s2">&quot;mocha/setup&quot;</span>
<span class="nb">require</span> <span class="s1">&#39;simplecov&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;capybara/dsl&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;capybara/rails&#39;</span>

<span class="no">SimpleCov</span><span class="o">.</span><span class="n">start</span>

<span class="k">module</span> <span class="nn">TestHelper</span>
  <span class="kp">include</span> <span class="ss">Capybara</span><span class="p">:</span><span class="ss">:DSL</span>

  <span class="k">def</span> <span class="nf">setup</span>
    <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="ss">:truncation</span>
    <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">clean_with</span><span class="p">(</span><span class="ss">:truncation</span><span class="p">)</span>
    <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">start</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">teardown</span>
    <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">clean</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
<p>Nice and simple! Let&#39;s take a closer at the gems we&#39;re using:</p>

<p><strong><a href="https://github.com/seattlerb/minitest">Minitest</a></strong> - I like to use MiniTest for
writing tests because of its simplicity and it provides a complete set of
testing facilities without the noise. Best of all it&#39;s shipped with Ruby 1.9.</p>

<p><strong><a href="http://gofreerange.com/mocha/docs/">Mocha</a></strong> - When we absolutely <em>need</em> to
mock or stub, I reach for Mocha since it&#39;s a good lightweight option. I found
Mocha to be the least fussy when it comes to stubbing.</p>

<p><strong><a href="https://github.com/colszowka/simplecov">SimpleCov</a></strong> is absolutely essential
  for measuring our code coverage. Our road to lean and mean tests start by
  knowing what has already been tested and what has yet to be tested.</p>

<p><strong><a href="https://github.com/bmabey/database_cleaner">DatabaseCleaner</a></strong> To avoid
banging our head against bizarre inconsistencies with the test database, we are
going to call on the help from DatbaseCleaner, which ensures that we have a clean database
state between tests.</p>

<p><strong><a href="http://jnicklas.github.io/capybara">Capybara</a></strong> Capybara is an intuitive web browser
simulation framework that allows us to test how a real user interacts with our web application. It
also comes with a built-in DSL for describing user interactions. We&#39;ll use
Capybara extensively for our acceptance tests.</p>

<h2>Achieving Testing Zen</h2>

<p>Now that we have a nice setup for our suite, we&#39;re ready to start adding
tests. How we approach testing is important if we want to keep our test suite
healthy. We want to write the minimal amount of code required to satisfy our
test cases. The best way to do this is using the Top-Down approach. This brings
us to our first tip.</p>

<p><strong>Tip #1: Start at the top.</strong> Start with the acceptance tests and drive our
  implementation at the user interface level. This can be a great way to
  prototype our implementation, and starting at the top, we can cover a lot of
  code with little tests. Once we are satisfied with our acceptance tests, we
  can fill-in holes with unit tests for complete public interface coverage.</p>

<p><strong>Tip #2: Use helper methods to keep your test DRY.</strong> To keep our tests nice and
   neat, extract common setup scenarios into helper methods. For example, if we
   know we have to log into the application to test our app, we can setup a
   handy login method:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">log_in_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="no">User</span><span class="o">.</span><span class="n">stubs</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">visit</span> <span class="s2">&quot;/login&quot;</span>

  <span class="n">within</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">fill_in</span> <span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">login</span>
    <span class="n">fill_in</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s2">&quot;anything&quot;</span>
  <span class="k">end</span>
  <span class="n">click_button</span> <span class="s2">&quot;Log in&quot;</span>
<span class="k">end</span>
</pre></div>
<p><strong>Tip #3: Avoid Copy and Paste.</strong> Sometimes it&#39;s so easy to copy and paste code
   from one test to another - especially our setup code. Before you copy and paste,
   ask yourself &quot;Should I move this code to a helper method instead?&quot;.</p>

<p><strong>Tip #4: Don&#39;t test what has already been tested.</strong> It may sound simple, but
chances are you&#39;ve written tests for code that has already been tested without
knowing it. I come across something like this quite often:</p>
<div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_many</span><span class="p">(</span><span class="ss">:orders</span><span class="p">)}</span>
<span class="k">end</span>
</pre></div>
<p>What exactly are we testing here? Are we just wanting to be extra sure that
we&#39;ve spelled the <code>has_many :order</code> association correctly in the User
model? ActiveRecord associations are well-tested by the Rails test suite, so
there is not need to have this in our test suite.</p>

<p><strong>Tip #6: Avoid Excessive use of mocks, stubs, and expectations.</strong> Too many
   mocks and stubs can lead to unexpected results and expectations often serve
   no benefit at all and almost always lock you to the internal implementation
   of the thing you&#39;re testing, thus making tests brittle. I have seen many
   projects use excessive mocks and often times it&#39;s not testing
   anything. Prefer to use real data from the database. The downside of this of
   course, is that our tests may be slower.</p>

<p><strong>Tip #7: Makes tests fast enough.</strong> We&#39;re not focusing too much on speed. Don&#39;t get
me wrong, if your tests are slow, you won&#39;t be encouraged to write them. So it&#39;s
important to keep speed in mind. But in the end, the most important thing we
want is a reliable, understandable code, even if they&#39;re not as fast as we&#39;d like
them to be.</p>

<p><strong>Tip #8: Keep context and describe blocks flat.</strong> Avoid deeply nested describe
   contexts. For example:</p>
<div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;checking out&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;add items in shopping cart&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">add_item_to_shopping_cart</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
      <span class="n">click_link</span> <span class="s1">&#39;Checkout&#39;</span>
    <span class="k">end</span>
    <span class="o">.</span><span class="n">.</span><span class="o">.</span>

    <span class="n">describe</span> <span class="s2">&quot;pay with credit card&quot;</span> <span class="k">do</span>
      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
<p>When go too deep in our describe blocks, it&#39;s easy to lose sight of the steps
taken in the previous describe blocks. To compound the problem, we can&#39;t be sure
of the database state either. Consider breaking describe blocks into separate
tests or even separate files when deep nesting occurs. For our example above,
we&#39;ll create a brand new test file for paying with credit card:</p>
<div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;paying with credit card&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="n">setup_shopping_cart_and_checkout</span>
    <span class="n">fill_in_credit_card_fields</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">&#39;checks for valid promotion codes&#39;</span> <span class="k">do</span>
    <span class="n">fill_in</span> <span class="s2">&quot;promo_code&quot;</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="s1">&#39;does not exists&#39;</span>
    <span class="n">click_link</span> <span class="s1">&#39;Place Order&#39;</span>
    <span class="n">assert</span> <span class="n">page</span><span class="o">.</span><span class="n">has_content?</span><span class="p">(</span><span class="s2">&quot;Sorry, invalid promotion code&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
<p><strong>Tip #9: Only test public side effects.</strong> If a method changes the internal state, write
  your assertions based on the side effects available to the public. Keep test
  cases to external API - allows us to change internal implementation, while
  ensuring the consumers of your class still work.</p>

<p>And that is it! By following these tips, you&#39;re on your way to achieving a happy
and health test suite. If you found this article helpful, you should also
checkout:</p>

<ol>
<li><a href="http://robots.thoughtbot.com/practical-guide-to-user-testing/">Practical Guide to User Testing</a></li>
<li><a href="http://blog.codeclimate.com/blog/2013/10/09/rails-testing-pyramid/">Rails Testing Pyramid</a></li>
<li><a href="http://mattsears.com/articles/2011/12/10/minitest-quick-reference">Minitest Quick Reference</a></li>
</ol>

<p>Got any tips to share? Please leave them in the comments.</p>
        </div>
      </div>
    </article>
    <div class='ten column centered'>
      <div id='disqus_thread'></div>
      <script type='text/javascript'>
        //<![CDATA[
          var disqus_shortname = 'mattsears';
          var disqus_identifier = "/articles/2013/12/17/a-guide-for-writing-maintainable-rails-tests";
          var disqus_url = "http://www.mattsears.com/articles/2013/12/17/a-guide-for-writing-maintainable-rails-tests";
          
          (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
          }());
          
          // The following are highly recommended additional parameters. Remove the slashes in front to use.
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        //]]>
      </script>
      <noscript>
        Please enable JavaScript to view the
        <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a>
      </noscript>
    </div>
  </div>
</div>
        <footer class='row text-center'>
          <div class='twelve columns'>
            <div class='row'>
              <div class='twelve columns'>
                <p>
                  Copyright © 2016 Matt Sears.
                </p>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        //
          var _gauges = _gauges || [];
          (function() {
            var t   = document.createElement('script');
            t.type  = 'text/javascript';
            t.async = true;
            t.id    = 'gauges-tracker';
            t.setAttribute('data-site-id', '4fb913d1f5a1f50be2000073');
            t.src = '//secure.gaug.es/track.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(t, s);
          })();
        //
      //]]>
    </script>
    <script src="/javascripts/all.js?1463433978" type="text/javascript"></script>
  </body>
</html>

